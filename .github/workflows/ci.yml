name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  tests:
    name: Run unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: python -m unittest discover

  docker-build:
    name: Build Docker images
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build service images
        env:
          BUILDER: ${{ steps.buildx.outputs.name }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/.buildx-cache
          services=(
            "mesh mesh/Dockerfile mesh"
            "osteon services/osteon/Dockerfile services/osteon"
            "myocyte services/myocyte/Dockerfile services/myocyte"
            "synapse services/synapse/Dockerfile services/synapse"
            "circadian services/circadian/Dockerfile services/circadian"
            "nucleus services/nucleus/Dockerfile services/nucleus"
            "chaperone services/chaperone/Dockerfile services/chaperone"
          )
          for entry in "${services[@]}"; do
            IFS=' ' read -r name file context <<< "$entry"
            echo "Building $name image"
            mkdir -p "/tmp/.buildx-cache/$name"
            rm -rf "/tmp/.buildx-cache/$name-new"
            docker buildx build \
              --builder "$BUILDER" \
              --cache-from type=local,src=/tmp/.buildx-cache/$name \
              --cache-to type=local,dest=/tmp/.buildx-cache/$name-new,mode=max \
              --load \
              --tag "$name:ci" \
              --file "$file" \
              "$context"
            rm -rf "/tmp/.buildx-cache/$name"
            if [ -d "/tmp/.buildx-cache/$name-new" ]; then
              mv "/tmp/.buildx-cache/$name-new" "/tmp/.buildx-cache/$name"
            fi
          done
